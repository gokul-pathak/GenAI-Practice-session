<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Document Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="h-screen flex bg-gray-100 font-sans">
    <!-- Sidebar -->
    <div class="w-[300px] bg-white border-r border-gray-300 flex flex-col">
      <h2
        class="m-0 p-4 border-b border-gray-300 bg-gray-100 text-center font-semibold"
      >
        Documents
      </h2>

      <div class="p-4 flex flex-col gap-3">
        <input type="file" id="fileInput" class="p-1 border rounded" />
        <input
          type="text"
          id="fileDesc"
          placeholder="Optional description"
          class="p-2 border rounded-md outline-none focus:ring-2 focus:ring-blue-500"
        />
        <button
          onclick="uploadFile()"
          class="bg-blue-600 hover:bg-blue-800 text-white py-2 rounded-full transition"
        >
          Upload
        </button>
        <div id="uploadStatus" class="text-sm text-gray-600"></div>
        <iframe
          id="docPreview"
          class="w-full h-[200px] border rounded mt-2 hidden"
        ></iframe>
      </div>

      <div
        class="flex-1 overflow-y-auto border-t border-gray-300 p-3"
        id="documentList"
      ></div>
    </div>

    <!-- Chat Panel -->
    <div class="flex-1 flex flex-col bg-gray-50">
      <div
        class="p-4 bg-blue-600 text-white font-bold flex justify-between items-center"
      >
        Document Chat Assistant
        <button
          onclick="resetChat()"
          class="bg-white text-blue-600 px-4 py-1 rounded-full hover:bg-gray-200 transition"
        >
          Reset
        </button>
      </div>

      <div
        class="flex-1 p-4 overflow-y-auto flex flex-col gap-3"
        id="chat"
      ></div>

      <div class="flex p-3 border-t border-gray-300 bg-white gap-3">
        <input
          id="message"
          placeholder="Type your question..."
          class="flex-1 p-3 border rounded-full outline-none focus:ring-2 focus:ring-blue-500"
        />
        <button
          onclick="sendMessage()"
          class="bg-blue-600 hover:bg-blue-800 text-white px-6 py-2 rounded-full transition"
        >
          Send
        </button>
      </div>
    </div>

    <!-- Bot reply sound -->
    <audio
      id="botSound"
      src="https://www.soundjay.com/button/beep-07.wav"
    ></audio>

    <script>
      let currentDocumentId = null;
      let sessionId = "default";
      const documents = [];

      function showError(message) {
        const chat = document.getElementById("chat");
        const errorDiv = document.createElement("div");
        errorDiv.className =
          "max-w-[70%] self-center bg-red-100 text-red-600 px-4 py-2 rounded-xl text-sm";
        errorDiv.textContent = message;
        chat.appendChild(errorDiv);
        chat.scrollTop = chat.scrollHeight;
      }

      async function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        if (!fileInput.files.length) {
          showError("Please select a file before uploading.");
          return;
        }

        const file = fileInput.files[0];
        const desc = document.getElementById("fileDesc").value;

        const formData = new FormData();
        formData.append("file", file);
        formData.append("metadata", JSON.stringify({ description: desc }));

        document.getElementById("uploadStatus").textContent = "Uploading...";

        try {
          const res = await fetch("http://127.0.0.1:8000/upload_document", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            throw new Error("Upload failed");
          }

          const data = await res.json();

          if (data.status === "success") {
            currentDocumentId = data.document_id;
            document.getElementById("uploadStatus").textContent =
              `Uploaded: ${data.filename}`;

            documents.length = 0; // clear old docs
            documents.push(data);
            renderDocuments();
            previewDocument(file);
          } else {
            showError("Upload failed.");
          }
        } catch (err) {
          console.error(err);
          showError("Error uploading file. Server might be down.");
        }
      }

      function renderDocuments() {
        const list = document.getElementById("documentList");
        list.innerHTML = "";

        documents.forEach((doc) => {
          const div = document.createElement("div");
          div.className =
            "p-2 border-b border-gray-200 cursor-pointer hover:bg-blue-100 transition" +
            (doc.document_id === currentDocumentId ? " bg-blue-100" : "");
          div.textContent = doc.filename;
          div.onclick = () => selectDocument(doc);
          list.appendChild(div);
        });
      }

      function selectDocument(doc) {
        currentDocumentId = doc.document_id;
        renderDocuments();
        document.getElementById("docPreview").classList.remove("hidden");
      }

      function previewDocument(file) {
        const preview = document.getElementById("docPreview");
        const url = URL.createObjectURL(file);

        if (file.type === "application/pdf") {
          preview.src = url;
          preview.classList.remove("hidden");
        } else if (file.type.startsWith("text/")) {
          const reader = new FileReader();
          reader.onload = () => {
            preview.srcdoc = `<pre>${reader.result}</pre>`;
            preview.classList.remove("hidden");
          };
          reader.readAsText(file);
        } else {
          preview.classList.add("hidden");
        }
      }

      async function sendMessage() {
        const input = document.getElementById("message");
        const chat = document.getElementById("chat");
        const userText = input.value.trim();

        if (!currentDocumentId) {
          showError("Please upload a document first.");
          return;
        }

        if (!userText) {
          showError("Message cannot be empty.");
          return;
        }

        const userDiv = document.createElement("div");
        userDiv.className =
          "max-w-[70%] self-end bg-blue-600 text-white px-4 py-2 rounded-2xl rounded-br-none";
        userDiv.textContent = userText;
        chat.appendChild(userDiv);
        chat.scrollTop = chat.scrollHeight;

        input.value = "";

        const typingDiv = document.createElement("div");
        typingDiv.className = "italic text-gray-500";
        typingDiv.textContent = "Bot is typing...";
        chat.appendChild(typingDiv);
        chat.scrollTop = chat.scrollHeight;

        try {
          const res = await fetch("http://127.0.0.1:8000/query_document", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              document_id: currentDocumentId,
              message: userText,
              session_id: sessionId,
            }),
          });

          if (!res.ok) {
            throw new Error("Query failed");
          }

          const data = await res.json();
          typingDiv.remove();

          const botDiv = document.createElement("div");
          botDiv.className =
            "max-w-[70%] self-start bg-gray-200 text-black px-4 py-2 rounded-2xl rounded-bl-none";
          botDiv.textContent = data.answer || "No response from server.";
          chat.appendChild(botDiv);
          chat.scrollTop = chat.scrollHeight;

          document.getElementById("botSound").play();
        } catch (err) {
          console.error(err);
          typingDiv.remove();
          showError("Error contacting server.");
        }
      }

      async function resetChat() {
      if (!currentDocumentId) {
        document.getElementById("chat").innerHTML = "";
        return;
      }

      const confirmDelete = confirm(
        "Are you sure you want to delete this document and all related data?"
      );

      if (!confirmDelete) return;

      try {
        const res = await fetch(
          `http://127.0.0.1:8000/delete_document/${currentDocumentId}`,
          {
            method: "DELETE",
          }
        );

        if (!res.ok) {
          throw new Error("Delete failed");
        }

        // ðŸ”¥ Clear chat UI
        document.getElementById("chat").innerHTML = "";

        // ðŸ”¥ Reset state
        documents.length = 0;
        currentDocumentId = null;
        renderDocuments();

        // ðŸ”¥ Clear preview
        const preview = document.getElementById("docPreview");
        preview.src = "";
        preview.srcdoc = "";
        preview.classList.add("hidden");

        // ðŸ”¥ Clear inputs
        document.getElementById("uploadStatus").textContent = "";
        document.getElementById("fileInput").value = "";
        document.getElementById("fileDesc").value = "";

      } catch (err) {
        console.error(err);
        showError("Failed to delete document from server.");
      }
    }
    </script>
  </body>
</html>
